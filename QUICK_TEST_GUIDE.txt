════════════════════════════════════════════════════════════════════
                    SERENCP QUICK TEST GUIDE
════════════════════════════════════════════════════════════════════

✓ TEST SUITE STATUS: READY

Test Files Created:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  ✓ t/mock_vm_server.pl       - Mock VM TCP server
  ✓ t/integration_test.pl     - Full integration test
  ✓ t/TESTING.md             - Detailed documentation
  ✓ run_tests.sh              - Main test runner

All scripts have valid syntax and are executable.


How serencp Dual-Mode Works:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Current behavior (which IS correct):

1. When you call: start(vm_name="myvm", port=4555)
   
   ┌─────────────────────────────────────────────────────────────────┐
   │ serencp.pl (MCP Mode - Line 515)                    │
   │                                                           │
   │   1. Creates PTY                                        │
   │   2. Creates Unix socket: /tmp/serial_myvm              │
   │   3. Calls: spawn_terminal_client(myvm, socket)          │
   │      ↓                                                   │
   │   4. Spawns: serencp.pl --socket=/tmp/serial_myvm       │
   │      (in new terminal window)                              │
   │                                                           │
   │   5. When VM data arrives:                                 │
   │      - Line 683: send_vm_output_notification() → STDOUT       │
   │        (JSON for LLM)                                       │
   │      - Line 703: forward to socket clients                   │
   │        (human terminal)                                       │
   └─────────────────────────────────────────────────────────────────┘

2. Result: Simultaneous dual output
   
   ┌──────────────────┐    ┌──────────────────┐
   │  LLM / MCP     │    │  Human User     │
   │                 │    │                 │
   │  JSON format:   │    │  Plain text:    │
   │  {             │    │  Welcome to    │
   │    "method":    │    │  Ubuntu 24.04   │
   │    "notifi-     │    │  login: _       │
   │    cations/     │    │                 │
   │    vm_output",  │    │                 │
   │    "params":     │    │                 │
   │    {...}        │    │                 │
   │  }             │    │                 │
   └────────┬─────────┘    └────────┬─────────┘
           │                        │
           │ Same VM Data          │ Same VM Data
           ▼                        ▼
           ┌──────────────────────────────────┐
           │  serencp.pl (MCP server)   │
           │  receives VM data once        │
           │  forwards to both outputs     │
           └──────────────────────────────────┘


Running the Test:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Method 1: Automated Test (Recommended)
─────────────────────────────────────────
  ./run_tests.sh

  This will:
  • Check dependencies
  • Start mock VM server (port 4556)
  • Start serencp in MCP mode
  • Initialize MCP connection
  • Start VM bridge
  • Display JSON notifications on console
  • Spawn terminal with VM output

  Expected results:
  ✓ Terminal window appears with mock VM boot output
  ✓ JSON notifications printed on your screen
  ✓ Both show same VM data simultaneously


Method 2: Manual Step-by-Step Test
─────────────────────────────────────────
  
  Terminal 1 - Start mock VM:
  ──────────────────────────────────
  perl t/mock_vm_server.pl --port=4556
  
  Terminal 2 - Start serencp:
  ──────────────────────────────────
  perl serencp.pl
  
  Terminal 3 - Send MCP commands:
  ──────────────────────────────────
  echo '{"jsonrpc":"2.0","id":1,"method":"initialize", ...}' | \
    ncat --shutclose localhost 12345
  
  Then:
  echo '{"jsonrpc":"2.0","id":2,"method":"tools/call", ...}' | \
    ncat --shutclose localhost 12345
  
  Where the JSON is:
  {
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/call",
    "params": {
      "name": "start",
      "arguments": {
        "vm_name": "test_vm",
        "port": "4556"
      }
    }
  }

  Expected:
  ✓ New terminal window appears (Terminal 4)
  ✓ Terminal 4 shows mock VM output
  ✓ Terminal 2 shows JSON notifications


Method 3: Manual Socket Connection
─────────────────────────────────────────
  # After starting serencp and bridge:
  perl serencp.pl --socket=/tmp/serial_test_vm
  
  This connects manually to the Unix socket.


What You'll See:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1. On your main terminal (MCP mode):
   ────────────────────────────────────────────
   [1] Notification received:
     VM: test_vm_integration
     Stream: stdout
     Timestamp: 2026-01-03T10:30:45.000Z
     Chunk: [    0.000000] Linux version 6.1.0-generic...

2. On the auto-spawned terminal:
   ────────────────────────────────────────────
   [    0.000000] Linux version 6.1.0-generic (mock@build) (gcc version 12.2.0)
   [    0.001234] BIOS-provided physical RAM map:
   [    0.002345] BIOS-e820: [mem 0x0000000000000000-0x000000000009fbff] usable
   ...
   mock-vm login: _


Testing Commands in Mock VM:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Once connected to mock VM, try these commands:
  ls        - List directory contents
  uptime    - Show system uptime
  date      - Show current date/time
  whoami    - Show current user
  top       - Show system processes
  exit      - Disconnect


Troubleshooting:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Terminal window doesn't appear?
  • Install: sudo apt install gnome-terminal xterm konsole
  • Check if terminal is in PATH: which xterm

Port already in use?
  • Kill old processes: pkill -f mock_vm_server
  • Kill serencp: pkill -f serencp.pl
  • Clean sockets: rm -f /tmp/serial_*

JSON parsing errors?
  • Ensure serencp.pl receives proper JSON-RPC 2.0 format
  • Check for extra characters (hidden BOM, etc.)


Architecture Overview:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

          ┌─────────────────┐
          │  Mock VM       │  ← TCP port 4556
          │  (telnet/tcp)  │
          └────────┬────────┘
                   │
                   ▼
          ┌─────────────────┐
          │  Bridge Child  │  ← Forked process
          │  (pty_slave)   │
          └────────┬────────┘
                   │
          ┌────────┴────────┐
          │      PTY        │
          └────────┬────────┘
                   │
        ┌──────────┴──────────┐
        │ serencp.pl (parent)│
        │   - Monitor bridge  │
        │   - Parse JSON     │
        │   - Send notifs    │
        └───┬────┬─────┬────┘
            │    │     │
        JSON   │     │   Unix Socket
     (LLM)    │     │  /tmp/serial_
    STDOUT    │     │      vm_name
              │     │
              └─────┴──► Terminal Client
                     (serencp.pl --socket)
                         (auto-spawned)


File Reference:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  t/mock_vm_server.pl
    • Simulates VM on TCP
    • Responds to commands
    • Perfect for testing without real VM

  t/integration_test.pl
    • Full automated test
    • Tests dual-mode operation
    • Validates JSON notifications

  t/TESTING.md
    • Detailed documentation
    • Test scenarios
    • Troubleshooting guide

  run_tests.sh
    • One-command test runner
    • Checks dependencies
    • Cleans up automatically


Summary:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✓ serencp.pl ALREADY supports dual-mode operation correctly!
  • LLM receives JSON notifications via STDOUT
  • Humans see output in auto-spawned terminal
  • Both views are synchronized in real-time

✓ Test suite verifies this behavior:
  • Mock VM simulates real serial console
  • Integration test validates JSON format
  • Terminal spawn verified by visual inspection

✓ To verify yourself:
  1. Run: ./run_tests.sh
  2. Observe terminal window appears
  3. Observe JSON notifications printed
  4. Both show same VM output!

════════════════════════════════════════════════════════════════════
